# Исправление поля isMain для изображений

## Проблема
При сохранении свойства в MongoDB поле `isMain` для изображений не сохранялось правильно, что приводило к тому, что ни одно изображение не отмечалось как главное.

## Внесенные изменения

### Backend (propertyController.js)

#### 1. Функция `createProperty`
- **Строки ~304-316**: Обновлена обработка изображений
  - Теперь при фильтрации изображений сохраняются ВСЕ поля: `url`, `publicId`, `alt`, `isMain`, `order`
  - Добавлена автоматическая проверка: если ни одно изображение не помечено как `isMain=true`, первое изображение автоматически становится главным
  - Добавлено логирование для отладки

#### 2. Функция `saveDraft`
- **Строки ~437-463**: Аналогичное обновление для черновиков
  - Сохранение всех полей изображений
  - Автоматическое назначение первого изображения главным, если нет `isMain=true`
  - Логирование для отладки

#### 3. Функция `updateProperty`
- **Строки ~567-596**: Добавлена обработка изображений при обновлении
  - Ранее изображения просто передавались как есть
  - Теперь применяется та же логика, что в `createProperty` и `saveDraft`
  - Гарантируется наличие хотя бы одного главного изображения

### Frontend (CreatePropertyPage.jsx)

#### 1. Функция `removeImage`
- **Строки ~376-396**: Улучшена логика удаления изображений
  - При удалении главного изображения автоматически назначается новое главное
  - Обновляется поле `order` для оставшихся изображений
  - Предотвращается ситуация, когда нет главного изображения

#### 2. Функция `handleSubmit`
- **Строки ~668-673**: Добавлено логирование
  - Выводит в консоль изображения перед отправкой на сервер
  - Помогает отладить проблемы с данными

#### 3. Функция `saveDraft`
- **Строки ~487-493**: Добавлено логирование
  - Выводит в консоль изображения при сохранении черновика

## Ключевые улучшения

1. **Сохранение всех полей изображений**: Теперь при фильтрации изображений сохраняются все важные поля (`isMain`, `order`, `alt`), а не только `url` и `publicId`

2. **Автоматическое назначение главного изображения**: Если ни одно изображение не помечено как главное, первое изображение автоматически получает `isMain=true`

3. **Консистентность данных**: Одинаковая логика обработки изображений во всех операциях (создание, обновление, сохранение черновика)

4. **Улучшенная отладка**: Добавлено логирование для отслеживания процесса обработки изображений

## Как проверить

1. Запустите backend сервер:
   ```bash
   cd nadlan_back
   npm run dev
   ```

2. Запустите frontend сервер:
   ```bash
   cd nadlan_front
   npm run dev
   ```

3. Создайте новое свойство и загрузите несколько изображений

4. Нажмите кнопку "עיקרית" (главная) на любой картинке

5. Сохраните или опубликуйте свойство

6. Проверьте в MongoDB, что поле `isMain: true` установлено для выбранного изображения

7. Откройте консоль браузера и посмотрите логи - должны увидеть:
   ```
   [handleSubmit] Images being sent: [...]
   ```

8. В логах backend должны увидеть:
   ```
   [createProperty] No main image found, setting first image as main
   ```
   (если не было явно выбрано главное изображение)

## Структура изображения в MongoDB

После этих изменений каждое изображение в массиве `images` будет иметь следующую структуру:

```javascript
{
  url: "https://res.cloudinary.com/...",
  publicId: "nadlan/properties/...",
  alt: "תמונה 1",
  isMain: true,  // ← Теперь сохраняется правильно!
  order: 0
}
```

## Дополнительные примечания

- Поле `isMain` должно быть `true` только для ОДНОГО изображения
- При удалении главного изображения автоматически назначается новое
- При загрузке первого изображения оно автоматически становится главным
- Логи помогают отследить весь процесс обработки изображений
